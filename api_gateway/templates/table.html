<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–∑–∏—Ç—ã</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #f5f5f7; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { color: #333; }
        .btn { background: #007AFF; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
        .btn:hover { background: #0056CC; }
        .btn-outline {
            background: white;
            color: #007AFF;
            border: 1px solid #007AFF;
        }
        .btn-outline:hover {
            background: #f0f7ff;
        }
        .btn-red { background: #FF3B30; }
        .btn-red:hover { background: #D70015; }
        .filters { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .filter input, .filter select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            margin-top: 5px; 
        }
        .filter-row {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .sort-controls select, .sort-controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        .sort-controls button:hover {
            background: #f0f0f0;
        }
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
            color: #555; 
            position: sticky; 
            top: 0; 
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background: #e8e9ea;
        }
        th.sort-asc::after {
            content: " ‚Üë";
            color: #007AFF;
        }
        th.sort-desc::after {
            content: " ‚Üì";
            color: #007AFF;
        }
        tr:hover { background: #f9f9f9; }
        .actions { display: flex; gap: 5px; }
        .status { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-scheduled { background: #E3F2FD; color: #1976D2; }
        .status-completed { background: #E8F5E9; color: #2E7D32; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; color: #555; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .loader { display: none; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .logout-btn { background: #FF3B30; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .missing-field { color: #999; font-style: italic; }
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .contract-date {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã –í–∏–∑–∏—Ç—ã</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="loadVisits()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" onclick="openModal('new')">+ –ù–æ–≤—ã–π –≤–∏–∑–∏—Ç</button>
            <button class="btn btn-outline" onclick="goToProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="filters">
        <div class="filter">
            <label>–§–ò–û</label>
            <input type="text" id="filter-fullname" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="text" id="filter-phone" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–ì–æ—Ä–æ–¥</label>
            <input type="text" id="filter-city" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–£–ª–∏—Ü–∞</label>
            <input type="text" id="filter-street" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>‚Ññ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</label>
            <input type="text" id="filter-contract" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–ú–∞—Å—Ç–µ—Ä</label>
            <select id="filter-master" onchange="filterTable()">
                <option value="">–í—Å–µ</option>
            </select>
        </div>
        <div class="filter">
            <label>–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
            <select id="filter-month" onchange="filterTable()">
                <option value="">–í—Å–µ</option>
            </select>
        </div>
        <div class="filter">
            <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞ —Å</label>
            <input type="date" id="filter-date-from" onchange="filterTable()">
        </div>
        <div class="filter">
            <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞ –ø–æ</label>
            <input type="date" id="filter-date-to" onchange="filterTable()">
        </div>
        <div class="filter">
            <label>–°—É–º–º–∞ –æ—Ç</label>
            <input type="number" id="filter-amount-from" step="0.01" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–°—É–º–º–∞ –¥–æ</label>
            <input type="number" id="filter-amount-to" step="0.01" oninput="filterTable()">
        </div>
        
        <div class="filter-row">
            <div class="sort-controls">
                <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</span>
                <select id="sort-field">
                    <option value="client.last_name">–§–ò–û</option>
                    <option value="client.phone">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                    <option value="address.city">–ì–æ—Ä–æ–¥</option>
                    <option value="address.street">–£–ª–∏—Ü–∞</option>
                    <option value="master">–ú–∞—Å—Ç–µ—Ä</option>
                    <option value="contract_number">‚Ññ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</option>
                    <option value="contract_date">–î–∞—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</option>
                    <option value="scheduled_date">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</option>
                    <option value="assigned_month">–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</option>
                    <option value="amount">–°—É–º–º–∞</option>
                </select>
                <select id="sort-order">
                    <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                    <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                </select>
                <button onclick="applySort()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
            <div>
                <span>–ù–∞–π–¥–µ–Ω–æ: <span id="results-count">0</span></span>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="loader" id="table-loader"></div>
        <table id="visits-table">
            <thead>
                <tr>
                    <th onclick="sortBy('client.last_name')">–§–ò–û</th>
                    <th onclick="sortBy('client.phone')">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th onclick="sortBy('address.city')">–ê–¥—Ä–µ—Å</th>
                    <th onclick="sortBy('master')">–ú–∞—Å—Ç–µ—Ä</th>
                    <th onclick="sortBy('contract_number')">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</th>
                    <th onclick="sortBy('scheduled_date')">–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</th>
                    <th onclick="sortBy('equipment_description')">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                    <th onclick="sortBy('assigned_month')">–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</th>
                    <th onclick="sortBy('amount')">–°—É–º–º–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">–ù–æ–≤—ã–π –≤–∏–∑–∏—Ç</h2>
                <button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">√ó</button>
            </div>
            <form id="visit-form" onsubmit="saveVisit(event)">
                <div class="form-grid">
                    <div class="form-group"><label>–§–∞–º–∏–ª–∏—è*</label><input type="text" id="lastname" required></div>
                    <div class="form-group"><label>–ò–º—è*</label><input type="text" id="firstname" required></div>
                    <div class="form-group"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input type="text" id="surname"></div>
                    <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω*</label><input type="tel" id="phone" required></div>
                    <div class="form-group"><label>–ú–∞—Å—Ç–µ—Ä</label><select id="masterid"></select></div>
                    <div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="city"></div>
                    <div class="form-group"><label>–†–∞–π–æ–Ω/–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç</label><input type="text" id="locality"></div>
                    <div class="form-group"><label>–†–µ–≥–∏–æ–Ω</label><input type="text" id="region"></div>
                    <div class="form-group"><label>–£–ª–∏—Ü–∞</label><input type="text" id="street"></div>
                    <div class="form-group"><label>–î–æ–º*</label><input type="number" id="housenumber" min="1" required></div>
                    <div class="form-group"><label>–õ–∏—Ç–µ—Ä–∞</label><input type="text" id="letter" maxlength="10"></div>
                    <div class="form-group"><label>–ö–æ—Ä–ø—É—Å</label><input type="number" id="building" min="1"></div>
                    <div class="form-group"><label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label><input type="number" id="appartmentnumber" min="1"></div>
                    <div class="form-group"><label>–ù–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</label><input type="text" id="contractnumber"></div>
                    <div class="form-group"><label>–î–∞—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</label><input type="date" id="contractdate"></div>
                    <div class="form-group"><label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</label><input type="date" id="scheduleddate"></div>
                    <div class="form-group"><label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞</label><input type="time" id="scheduledtime"></div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
                        <textarea id="equipmentdescription" rows="3"></textarea>
                    </div>
                    <div class="form-group"><label>–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label><input type="month" id="assignedmonth"></div>
                    <div class="form-group"><label>–°—É–º–º–∞</label><input type="number" step="0.01" id="amount" min="0"></div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-red" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3425';
        let visits = [];
        let masters = [];
        let currentVisitId = null;
        let isLoading = false;
        let currentSortField = 'client.last_name';
        let currentSortOrder = 'asc';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!localStorage.getItem('auth_token')) {
            window.location.href = '/';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞
        function getUserIdFromToken() {
            const token = localStorage.getItem('auth_token');
            if (!token) return null;
            
            try {
                // JWT —Ç–æ–∫–µ–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö —á–∞—Å—Ç–µ–π: header.payload.signature
                const parts = token.split('.');
                if (parts.length !== 3) {
                    console.error('Invalid token format');
                    return null;
                }
                
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º payload (–≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å)
                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(atob(base64));
                
                console.log('Token payload:', payload); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º user_id (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è: id, userId, sub)
                return payload.user_id || payload.id || payload.sub || null;
            } catch (e) {
                console.error('Error decoding token:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å
        function goToProfile() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞
            const userId = getUserIdFromToken();
            
            if (userId) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤ localStorage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è
                localStorage.setItem('profile_user_id', userId);
                console.log('User ID saved to localStorage:', userId);
            } else {
                console.warn('Could not get user ID from token');
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Ñ–∏–ª—è
            window.location.href = `/user/profile?token=${encodeURIComponent(token)}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                document.getElementById('table-loader').style.display = 'block';
                
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                
                const [visitsRes, mastersRes] = await Promise.all([
                    fetch(`${API_URL}/visit/visits`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                    }),
                    fetch(`${API_URL}/user/masters`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                    })
                ]);

                if (!visitsRes.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–æ–≤: ${visitsRes.status}`);
                if (!mastersRes.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Å—Ç–µ—Ä–æ–≤: ${mastersRes.status}`);
                
                visits = await visitsRes.json();
                masters = await mastersRes.json();
                
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', {
                    visits: visits.length,
                    masters: masters.length
                });
                
                if (visits.length > 0) {
                    console.log('–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤–∏–∑–∏—Ç–∞:', JSON.stringify(visits[0], null, 2));
                }
                
                renderTable();
                populateFilters();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            } finally {
                document.getElementById('table-loader').style.display = 'none';
                isLoading = false;
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
        function formatAddress(address) {
            if (!address) return '-';
            
            const parts = [];
            if (address.city) parts.push(address.city);
            if (address.locality) parts.push(address.locality);
            if (address.street) parts.push(`—É–ª. ${address.street}`);
            if (address.house_number) parts.push(`–¥. ${address.house_number}`);
            if (address.letter) parts.push(`–ª–∏—Ç. ${address.letter}`);
            if (address.building) parts.push(`–∫. ${address.building}`);
            if (address.appartment_number) parts.push(`–∫–≤. ${address.appartment_number}`);
            
            return parts.length > 0 ? parts.join(', ') : '-';
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–ò–û
        function formatFullName(client) {
            if (!client) return '-';
            const parts = [];
            if (client.last_name) parts.push(client.last_name);
            if (client.first_name) parts.push(client.first_name);
            if (client.surname) parts.push(client.surname);
            return parts.length > 0 ? parts.join(' ') : '-';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function getSortValue(visit, field) {
            switch(field) {
                case 'client.last_name':
                    return visit.client?.last_name || '';
                case 'client.phone':
                    return visit.client?.phone || '';
                case 'address.city':
                    return visit.address?.city || '';
                case 'address.street':
                    return visit.address?.street || '';
                case 'master':
                    const master = masters.find(m => m.master_id === visit.master_id);
                    return master ? `${master.master_lastname} ${master.master_firstname}` : '';
                case 'contract_number':
                    return visit.contract_number || '';
                case 'contract_date':
                    return visit.contract_date || '';
                case 'scheduled_date':
                    return visit.scheduled_date || '';
                case 'assigned_month':
                    return visit.assigned_month || '';
                case 'equipment_description':
                    return visit.equipment_description || '';
                case 'amount':
                    return visit.amount || 0;
                default:
                    return '';
            }
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        function sortVisits(visits, field, order) {
            return [...visits].sort((a, b) => {
                let valA = getSortValue(a, field);
                let valB = getSortValue(b, field);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
                if (field === 'amount') {
                    valA = Number(valA) || 0;
                    valB = Number(valB) || 0;
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∞—Ç
                if (field === 'scheduled_date' || field === 'contract_date') {
                    valA = valA ? new Date(valA).getTime() : 0;
                    valB = valB ? new Date(valB).getTime() : 0;
                }
                
                if (order === 'asc') {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        function filterVisits() {
            const fullNameFilter = document.getElementById('filter-fullname').value.toLowerCase();
            const phoneFilter = document.getElementById('filter-phone').value.toLowerCase();
            const cityFilter = document.getElementById('filter-city').value.toLowerCase();
            const streetFilter = document.getElementById('filter-street').value.toLowerCase();
            const contractFilter = document.getElementById('filter-contract').value.toLowerCase();
            const masterFilter = document.getElementById('filter-master').value;
            const monthFilter = document.getElementById('filter-month').value;
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const amountFrom = document.getElementById('filter-amount-from').value;
            const amountTo = document.getElementById('filter-amount-to').value;
            
            const filtered = visits.filter(visit => {
                const fullName = formatFullName(visit.client).toLowerCase();
                const phone = visit.client?.phone || '';
                const city = visit.address?.city || '';
                const street = visit.address?.street || '';
                const contract = visit.contract_number || '';
                const scheduledDate = visit.scheduled_date ? new Date(visit.scheduled_date) : null;
                const amount = Number(visit.amount) || 0;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const nameMatch = !fullNameFilter || fullName.includes(fullNameFilter);
                const phoneMatch = !phoneFilter || phone.toLowerCase().includes(phoneFilter);
                const cityMatch = !cityFilter || city.toLowerCase().includes(cityFilter);
                const streetMatch = !streetFilter || street.toLowerCase().includes(streetFilter);
                const contractMatch = !contractFilter || contract.toLowerCase().includes(contractFilter);
                const masterMatch = !masterFilter || visit.master_id == masterFilter;
                const monthMatch = !monthFilter || visit.assigned_month === monthFilter;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                let dateMatch = true;
                if (dateFrom && scheduledDate) {
                    dateMatch = scheduledDate >= new Date(dateFrom);
                }
                if (dateMatch && dateTo && scheduledDate) {
                    dateMatch = scheduledDate <= new Date(dateTo + 'T23:59:59');
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ —Å—É–º–º–µ
                let amountMatch = true;
                if (amountFrom) {
                    amountMatch = amount >= Number(amountFrom);
                }
                if (amountMatch && amountTo) {
                    amountMatch = amount <= Number(amountTo);
                }
                
                return nameMatch && phoneMatch && cityMatch && streetMatch && 
                       contractMatch && masterMatch && monthMatch && dateMatch && amountMatch;
            });
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            const sorted = sortVisits(filtered, currentSortField, currentSortOrder);
            
            document.getElementById('results-count').textContent = filtered.length;
            
            return sorted;
        }

        // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const filteredData = filterVisits();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if (!filteredData || filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }
            
            filteredData.forEach(visit => {
                const row = document.createElement('tr');
                
                const fullName = formatFullName(visit.client);
                const phone = visit.client?.phone || '-';
                const address = formatAddress(visit.address);
                
                const master = masters.find(m => m.master_id === visit.master_id);
                const masterName = master ? `${master.master_firstname} ${master.master_lastname}` : '-';
                
                const contractNumber = visit.contract_number || '-';
                const contractDate = visit.contract_date ? new Date(visit.contract_date).toLocaleDateString('ru-RU') : '';
                const contractDisplay = contractDate ? `${contractNumber}<div class="contract-date">–æ—Ç ${contractDate}</div>` : contractNumber;
                
                const date = visit.scheduled_date ? new Date(visit.scheduled_date).toLocaleDateString('ru-RU') : '-';
                const time = visit.scheduled_time || '';
                const scheduledDateTime = time ? `${date} –≤ ${time}` : date;
                
                const equipment = visit.equipment_description || '-';
                const equipmentShort = equipment.length > 50 ? equipment.substring(0, 50) + '...' : equipment;
                
                const month = visit.assigned_month || '-';
                const amount = visit.amount ? Number(visit.amount).toLocaleString('ru-RU') + ' ‚ÇΩ' : '-';
                
                // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É JSON –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ editVisit
                const visitJson = JSON.stringify(visit).replace(/</g, '\\u003c').replace(/>/g, '\\u003e');
                
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${phone}</td>
                    <td class="tooltip">
                        ${address.length > 30 ? address.substring(0, 30) + '...' : address}
                        ${address.length > 30 ? `<span class="tooltiptext">${address}</span>` : ''}
                    </td>
                    <td>${masterName}</td>
                    <td class="tooltip">
                        ${contractDisplay}
                        ${contractNumber.length > 15 ? `<span class="tooltiptext">${contractNumber}</span>` : ''}
                    </td>
                    <td>${scheduledDateTime}</td>
                    <td class="tooltip">
                        ${equipmentShort}
                        ${equipment.length > 50 ? `<span class="tooltiptext">${equipment}</span>` : ''}
                    </td>
                    <td>${month}</td>
                    <td>${amount}</td>
                    <td class="actions">
                        <button class="btn" onclick='editVisit(${visitJson})'>‚úèÔ∏è</button>
                        <button class="btn btn-red" onclick="deleteVisit(${visit.id})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
            updateSortIndicators();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function updateSortIndicators() {
            const headers = document.querySelectorAll('th');
            headers.forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const sortedHeader = Array.from(headers).find(th => 
                th.textContent.toLowerCase().includes(currentSortField.split('.')[1] || currentSortField)
            );
            
            if (sortedHeader) {
                sortedHeader.classList.add(currentSortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        function sortBy(field) {
            if (currentSortField === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortOrder = 'asc';
            }
            
            document.getElementById('sort-field').value = field;
            document.getElementById('sort-order').value = currentSortOrder;
            
            renderTable();
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
        function applySort() {
            currentSortField = document.getElementById('sort-field').value;
            currentSortOrder = document.getElementById('sort-order').value;
            renderTable();
        }

        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            document.getElementById('filter-fullname').value = '';
            document.getElementById('filter-phone').value = '';
            document.getElementById('filter-city').value = '';
            document.getElementById('filter-street').value = '';
            document.getElementById('filter-contract').value = '';
            document.getElementById('filter-master').value = '';
            document.getElementById('filter-month').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-amount-from').value = '';
            document.getElementById('filter-amount-to').value = '';
            
            currentSortField = 'client.last_name';
            currentSortOrder = 'asc';
            document.getElementById('sort-field').value = 'client.last_name';
            document.getElementById('sort-order').value = 'asc';
            
            renderTable();
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function populateFilters() {
            const masterSelect = document.getElementById('filter-master');
            const monthSelect = document.getElementById('filter-month');
            
            // –ú–∞—Å—Ç–µ—Ä–∞
            masterSelect.innerHTML = '<option value="">–í—Å–µ</option>';
            
            if (masters && masters.length > 0) {
                masters.forEach(master => {
                    masterSelect.innerHTML += `<option value="${master.master_id}">${master.master_firstname} ${master.master_lastname}</option>`;
                });
            }
            
            // –ú–µ—Å—è—Ü—ã
            const months = [...new Set(visits.map(v => v.assigned_month).filter(Boolean))].sort();
            monthSelect.innerHTML = '<option value="">–í—Å–µ</option>';
            months.forEach(month => {
                let displayMonth = month;
                if (month && month.match(/^\d{4}-\d{2}$/)) {
                    const [year, monthNum] = month.split('-');
                    const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                                      '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                    displayMonth = `${monthNames[parseInt(monthNum)-1]} ${year}`;
                }
                monthSelect.innerHTML += `<option value="${month}">${displayMonth}</option>`;
            });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        function filterTable() {
            renderTable();
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function openModal(type, visit = null) {
            if (isLoading) {
                alert('–î–∞–Ω–Ω—ã–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...');
                return;
            }
            
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('visit-form');
            
            currentVisitId = visit?.id || null;
            title.textContent = type === 'new' ? '–ù–æ–≤—ã–π –≤–∏–∑–∏—Ç' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∑–∏—Ç';
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–µ
            const masterSelect = document.getElementById('masterid');
            masterSelect.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
            
            if (masters && masters.length > 0) {
                masters.forEach(master => {
                    masterSelect.innerHTML += `<option value="${master.master_id}">${master.master_firstname} ${master.master_lastname}</option>`;
                });
            }
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            if (visit) {
                document.getElementById('lastname').value = visit.client?.last_name || '';
                document.getElementById('firstname').value = visit.client?.first_name || '';
                document.getElementById('surname').value = visit.client?.surname || '';
                document.getElementById('phone').value = visit.client?.phone || '';
                
                if (visit.master_id) document.getElementById('masterid').value = visit.master_id;
                
                document.getElementById('city').value = visit.address?.city || '';
                document.getElementById('locality').value = visit.address?.locality || '';
                document.getElementById('region').value = visit.address?.region || '';
                document.getElementById('street').value = visit.address?.street || '';
                document.getElementById('housenumber').value = visit.address?.house_number || '';
                document.getElementById('letter').value = visit.address?.letter || '';
                document.getElementById('building').value = visit.address?.building || '';
                document.getElementById('appartmentnumber').value = visit.address?.appartment_number || '';
                
                document.getElementById('contractnumber').value = visit.contract_number || '';
                document.getElementById('equipmentdescription').value = visit.equipment_description || '';
                document.getElementById('amount').value = visit.amount || '';
                
                if (visit.contract_date) {
                    document.getElementById('contractdate').value = visit.contract_date.split('T')[0];
                }
                if (visit.scheduled_date) {
                    document.getElementById('scheduleddate').value = visit.scheduled_date.split('T')[0];
                }
                if (visit.scheduled_time) {
                    document.getElementById('scheduledtime').value = visit.scheduled_time;
                }
                if (visit.assigned_month) {
                    document.getElementById('assignedmonth').value = visit.assigned_month + '-01';
                }
            } else {
                form.reset();
                document.getElementById('assignedmonth').value = new Date().toISOString().slice(0, 7) + '-01';
            }
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('visit-form').reset();
            currentVisitId = null;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞
        async function saveVisit(event) {
            event.preventDefault();
            
            const visitData = {
                client: {
                    first_name: document.getElementById('firstname').value,
                    last_name: document.getElementById('lastname').value,
                    surname: document.getElementById('surname').value || '',
                    phone: document.getElementById('phone').value
                },
                address: {
                    city: document.getElementById('city').value || '',
                    locality: document.getElementById('locality').value || '',
                    region: document.getElementById('region').value || '',
                    street: document.getElementById('street').value || '',
                    house_number: parseInt(document.getElementById('housenumber').value) || 0,
                    letter: document.getElementById('letter').value || '',
                    building: document.getElementById('building').value ? parseInt(document.getElementById('building').value) : null,
                    appartment_number: document.getElementById('appartmentnumber').value ? parseInt(document.getElementById('appartmentnumber').value) : null
                },
                contract_number: document.getElementById('contractnumber').value || '',
                contract_date: document.getElementById('contractdate').value 
                    ? document.getElementById('contractdate').value + 'T00:00:00Z'
                    : '',
                scheduled_date: document.getElementById('scheduleddate').value 
                    ? document.getElementById('scheduleddate').value + 'T00:00:00Z'
                    : null,
                scheduled_time: document.getElementById('scheduledtime').value || '',
                equipment_description: document.getElementById('equipmentdescription').value || '',
                assigned_month: document.getElementById('assignedmonth').value 
                    ? document.getElementById('assignedmonth').value.slice(0, 7) 
                    : '',
                amount: document.getElementById('amount').value 
                    ? parseFloat(document.getElementById('amount').value) 
                    : null,
                master_id: document.getElementById('masterid').value 
                    ? parseInt(document.getElementById('masterid').value) 
                    : null
            };

            // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
            if (!visitData.contract_number) delete visitData.contract_number;
            if (!visitData.contract_date) delete visitData.contract_date;
            if (!visitData.scheduled_date) delete visitData.scheduled_date;
            if (!visitData.scheduled_time) delete visitData.scheduled_time;
            if (!visitData.equipment_description) delete visitData.equipment_description;
            if (!visitData.assigned_month) delete visitData.assigned_month;
            if (visitData.amount === null) delete visitData.amount;
            if (visitData.master_id === null) delete visitData.master_id;
            
            if (visitData.address.building === null) delete visitData.address.building;
            if (visitData.address.appartment_number === null) delete visitData.address.appartment_number;
            
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', JSON.stringify(visitData, null, 2));

            try {
                const endpoint = currentVisitId 
                    ? `${API_URL}/visit/visits/${currentVisitId}` 
                    : `${API_URL}/visit/visits`;
                
                const method = currentVisitId ? 'PUT' : 'POST';
                
                const res = await fetch(endpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(visitData)
                });
                
                if (res.ok) {
                    closeModal();
                    await loadData();
                    alert(currentVisitId ? '–í–∏–∑–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω' : '–í–∏–∑–∏—Ç —Å–æ–∑–¥–∞–Ω');
                } else {
                    const errorText = await res.text();
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    } catch {
                        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + errorText);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        function editVisit(visit) {
            openModal('edit', visit);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ
        async function deleteVisit(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–∑–∏—Ç?')) return;
            
            try {
                const res = await fetch(`${API_URL}/visit/visits/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                
                if (res.ok) {
                    await loadData();
                    alert('–í–∏–∑–∏—Ç —É–¥–∞–ª–µ–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/';
        }

        function loadVisits() {
            loadData();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>