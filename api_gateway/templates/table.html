<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–∑–∏—Ç—ã</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #f5f5f7; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { color: #333; }
        .btn { background: #007AFF; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #0056CC; }
        .btn-red { background: #FF3B30; }
        .btn-red:hover { background: #D70015; }
        .filters { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter input, .filter select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px; }
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; position: sticky; top: 0; }
        tr:hover { background: #f9f9f9; }
        .actions { display: flex; gap: 5px; }
        .status { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-scheduled { background: #E3F2FD; color: #1976D2; }
        .status-completed { background: #E8F5E9; color: #2E7D32; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; color: #555; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .loader { display: none; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .logout-btn { background: #FF3B30; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã –í–∏–∑–∏—Ç—ã</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn" onclick="loadVisits()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" onclick="openModal('new')">+ –ù–æ–≤—ã–π –≤–∏–∑–∏—Ç</button>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="filters">
        <div class="filter">
            <label>–§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="filter-lastname" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="text" id="filter-phone" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–ì–æ—Ä–æ–¥</label>
            <input type="text" id="filter-city" oninput="filterTable()">
        </div>
        <div class="filter">
            <label>–ú–∞—Å—Ç–µ—Ä</label>
            <select id="filter-master" onchange="filterTable()">
                <option value="">–í—Å–µ</option>
            </select>
        </div>
        <div class="filter">
            <label>–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
            <select id="filter-month" onchange="filterTable()">
                <option value="">–í—Å–µ</option>
            </select>
        </div>
    </div>

    <div class="table-container">
        <div class="loader" id="table-loader"></div>
        <table id="visits-table">
            <thead>
                <tr>
                    <th>–§–ò–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ê–¥—Ä–µ—Å</th>
                    <th>–ú–∞—Å—Ç–µ—Ä</th>
                    <th>–ö–æ–Ω—Ç—Ä–∞–∫—Ç</th>
                    <th>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</th>
                    <th>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</th>
                    <th>–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">–ù–æ–≤—ã–π –≤–∏–∑–∏—Ç</h2>
                <button onclick="closeModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">√ó</button>
            </div>
            <form id="visit-form" onsubmit="saveVisit(event)">
                <div class="form-grid">
                    <div class="form-group"><label>–§–∞–º–∏–ª–∏—è*</label><input type="text" id="lastname" required></div>
                    <div class="form-group"><label>–ò–º—è*</label><input type="text" id="firstname" required></div>
                    <div class="form-group"><label>–û—Ç—á–µ—Å—Ç–≤–æ</label><input type="text" id="surname"></div>
                    <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω*</label><input type="tel" id="phone" required></div>
                    <div class="form-group"><label>–ú–∞—Å—Ç–µ—Ä</label><select id="masterid"></select></div>
                    <div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="city"></div>
                    <div class="form-group"><label>–£–ª–∏—Ü–∞</label><input type="text" id="street"></div>
                    <div class="form-group"><label>–î–æ–º</label><input type="number" id="housenumber" min="1"></div>
                    <div class="form-group"><label>–ö–æ—Ä–ø—É—Å</label><input type="number" id="building" min="1"></div>
                    <div class="form-group"><label>–ö–≤–∞—Ä—Ç–∏—Ä–∞</label><input type="number" id="appartmentnumber" min="1"></div>
                    <div class="form-group"><label>–ù–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</label><input type="text" id="contractnumber"></div>
                    <div class="form-group"><label>–î–∞—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</label><input type="date" id="contractdate"></div>
                    <div class="form-group"><label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞</label><input type="date" id="scheduleddate"></div>
                    <div class="form-group"><label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞</label><input type="time" id="scheduledtime"></div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</label>
                        <textarea id="equipmentdescription" rows="3"></textarea>
                    </div>
                    <div class="form-group"><label>–ú–µ—Å—è—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label><input type="month" id="assignedmonth"></div>
                    <div class="form-group"><label>–°—É–º–º–∞</label><input type="number" step="0.01" id="amount" min="0"></div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-red" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3425';
        let visits = [];
        let masters = [];
        let currentVisitId = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!localStorage.getItem('auth_token')) {
            window.location.href = '/auth.html';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                document.getElementById('table-loader').style.display = 'block';
                
                const [visitsRes, mastersRes] = await Promise.all([
                    fetch(`${API_URL}/visits`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                    }),
                    fetch(`${API_URL}/user/masters`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                    })
                ]);

                if (!visitsRes.ok || !mastersRes.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                
                visits = await visitsRes.json();
                masters = await mastersRes.json();
                
                renderTable();
                populateFilters();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            } finally {
                document.getElementById('table-loader').style.display = 'none';
            }
        }

        // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
        function renderTable(data = visits) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            data.forEach(visit => {
                const row = document.createElement('tr');
                const fullName = `${visit.lastname || ''} ${visit.firstname || ''} ${visit.surname || ''}`.trim();
                const address = [
                    visit.city,
                    visit.street,
                    visit.housenumber,
                    visit.letter,
                    visit.building ? `–∫.${visit.building}` : '',
                    visit.appartmentnumber ? `–∫–≤.${visit.appartmentnumber}` : ''
                ].filter(Boolean).join(', ');
                
                const master = masters.find(m => m.master_id === visit.masterid);
                const masterName = master ? `${master.master_firstname} ${master.master_lastname}` : '-';
                
                const date = visit.scheduleddate ? new Date(visit.scheduleddate).toLocaleDateString('ru-RU') : '-';
                const time = visit.scheduledtime || '';
                
                row.innerHTML = `
                    <td>${fullName || '-'}</td>
                    <td>${visit.phone || '-'}</td>
                    <td>${address || '-'}</td>
                    <td>${masterName}</td>
                    <td>${visit.contractnumber || '-'}</td>
                    <td>${date} ${time ? `–≤ ${time}` : ''}</td>
                    <td>${visit.equipmentdescription ? visit.equipmentdescription.substring(0, 50) + (visit.equipmentdescription.length > 50 ? '...' : '') : '-'}</td>
                    <td><span class="status status-scheduled">${visit.assignedmonth || '-'}</span></td>
                    <td>${visit.amount ? Number(visit.amount).toLocaleString('ru-RU') + ' ‚ÇΩ' : '-'}</td>
                    <td class="actions">
                        <button class="btn" onclick="editVisit(${JSON.stringify(visit).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                        <button class="btn btn-red" onclick="deleteVisit(${visit.id || visit.contractnumber || ''})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function populateFilters() {
            const masterSelect = document.getElementById('filter-master');
            const monthSelect = document.getElementById('filter-month');
            
            // –ú–∞—Å—Ç–µ—Ä–∞
            masterSelect.innerHTML = '<option value="">–í—Å–µ</option>';
            masters.forEach(master => {
                masterSelect.innerHTML += `<option value="${master.master_id}">${master.master_firstname} ${master.master_lastname}</option>`;
            });
            
            // –ú–µ—Å—è—Ü—ã
            const months = [...new Set(visits.map(v => v.assignedmonth).filter(Boolean))].sort();
            monthSelect.innerHTML = '<option value="">–í—Å–µ</option>';
            months.forEach(month => {
                monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
            });
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        function filterTable() {
            const lastNameFilter = document.getElementById('filter-lastname').value.toLowerCase();
            const phoneFilter = document.getElementById('filter-phone').value.toLowerCase();
            const cityFilter = document.getElementById('filter-city').value.toLowerCase();
            const masterFilter = document.getElementById('filter-master').value;
            const monthFilter = document.getElementById('filter-month').value;
            
            const filtered = visits.filter(visit => {
                return (!lastNameFilter || (visit.lastname || '').toLowerCase().includes(lastNameFilter)) &&
                       (!phoneFilter || (visit.phone || '').includes(phoneFilter)) &&
                       (!cityFilter || (visit.city || '').toLowerCase().includes(cityFilter)) &&
                       (!masterFilter || visit.masterid == masterFilter) &&
                       (!monthFilter || visit.assignedmonth === monthFilter);
            });
            
            renderTable(filtered);
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function openModal(type, visit = null) {
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('visit-form');
            
            currentVisitId = visit?.id || null;
            title.textContent = type === 'new' ? '–ù–æ–≤—ã–π –≤–∏–∑–∏—Ç' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∑–∏—Ç';
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–æ–≤ –≤ —Ñ–æ—Ä–º–µ
            const masterSelect = document.getElementById('masterid');
            masterSelect.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
            masters.forEach(master => {
                masterSelect.innerHTML += `<option value="${master.master_id}">${master.master_firstname} ${master.master_lastname}</option>`;
            });
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            if (visit) {
                Object.keys(visit).forEach(key => {
                    const element = document.getElementById(key);
                    if (element && visit[key] !== null) {
                        element.value = visit[key];
                    }
                });
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
                if (visit.contractdate) {
                    document.getElementById('contractdate').value = visit.contractdate.split('T')[0];
                }
                if (visit.scheduleddate) {
                    document.getElementById('scheduleddate').value = visit.scheduleddate.split('T')[0];
                }
                if (visit.assignedmonth) {
                    document.getElementById('assignedmonth').value = visit.assignedmonth + '-01';
                }
            } else {
                form.reset();
                document.getElementById('assignedmonth').value = new Date().toISOString().slice(0, 7) + '-01';
            }
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('visit-form').reset();
            currentVisitId = null;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∏–∑–∏—Ç–∞
        async function saveVisit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤
            if (data.masterid === '') delete data.masterid;
            if (data.building === '') delete data.building;
            if (data.appartmentnumber === '') delete data.appartmentnumber;
            if (data.amount === '') delete data.amount;
            if (data.scheduleddate === '') delete data.scheduleddate;
            if (data.assignedmonth) data.assignedmonth = data.assignedmonth.slice(0, 7);
            
            try {
                const endpoint = currentVisitId ? `${API_URL}/visits/${currentVisitId}` : `${API_URL}/visits`;
                const method = currentVisitId ? 'PUT' : 'POST';
                
                const res = await fetch(endpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    closeModal();
                    loadData();
                    alert(currentVisitId ? '–í–∏–∑–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω' : '–í–∏–∑–∏—Ç —Å–æ–∑–¥–∞–Ω');
                } else {
                    const error = await res.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        function editVisit(visit) {
            openModal('edit', visit);
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ
        async function deleteVisit(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–∑–∏—Ç?')) return;
            
            try {
                const res = await fetch(`${API_URL}/visits/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                
                if (res.ok) {
                    loadData();
                    alert('–í–∏–∑–∏—Ç —É–¥–∞–ª–µ–Ω');
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            localStorage.removeItem('auth_token');
            window.location.href = '/auth.html';
        }

        function loadVisits() {
            loadData();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>